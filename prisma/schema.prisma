// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  OPERATOR
  USER
}

enum AlertStatus {
  ACTIVE        // waiting for your decision
  SENT          // drone dispatched
  NEUTRALISED   // manually neutralised / ignored
}

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  password  String
  name      String
  role      Role     @default(USER)
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Area {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  areaId    String   @unique // e.g., AREA-006
  name      String   // e.g., North Sector Zone B
  latitude  Float    // Range: -90 to 90
  longitude Float    // Range: -180 to 180
  status    String   @default("Active") // Active/Inactive
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  addedBy    String @default("")   // User who added the area

  // Relations
  sensors       Sensor[]
  alarms        Alarm[]
  drones        DroneOS[]

  @@map("areas")
}

model Sensor {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  sensorId   String   @unique // Unique sensor ID
  name       String   // Sensor name
  sensorType String   // Type of sensor
  latitude   Float    // Sensor location latitude
  longitude  Float    // Sensor location longitude
  ipAddress  String?  // Optional IP address
  rtspUrl    String?  // Optional RTSP URL for live stream
  battery    String?  // Battery status
  status     String   // Sensor status (Active/Inactive)
  
  // Drone control fields
  sendDrone       String   @default("No") // Auto-launch drone? Yes/No
  activeShuruMode String   // Active/Shuru sensor state
  
  // Relations
  areaId  String? @db.ObjectId
  area    Area?   @relation(fields: [areaId], references: [id], onDelete: Cascade)
  
  alarmId String? @db.ObjectId
  alarm   Alarm?  @relation(fields: [alarmId], references: [id], onDelete: SetNull)

  alerts        Alert[]

  addedBy    String @default("")   // User who added the sensor
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sensors")
}

model DroneOS {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  droneId           String?   @unique // Unique drone ID (similar to sensorId)
  droneOSName       String   // Drone OS name
  droneType         String   // e.g., quadcopter, hexacopter
  videoLink         String?  // Video feed link
  gpsFix            String   // GPS fix value
  minHDOP           Float    // Min HDOP (1<0): Range 0-1
  minSatCount       Int      // Min Sat Count (1-8): Range 0-8
  maxWindSpeed      Float    // Max Wind Speed in m/s
  droneSpeed        Float    // Drone Speed in m/s
  targetAltitude    Float    // Target Altitude in meters
  gpsLost           String   // Action on GPS lost
  telemetryLost     String   // Action on telemetry lost
  minBatteryLevel   Float    // Min Battery Level in percentage
  usbAddress        String   // USB Address
  batteryFailSafe   String   // Action on battery fail safe (RTL, Land)
  gpsName           String   // GPS Name
  maxAltitude       Float    // Max Altitude in meters
  latitude          Float?    // Home Latitude
  longitude         Float?    // Home Longitude
  addedBy           String @default("")   // User who added the drone

  lastLatitude   Float?
  lastLongitude  Float?
  lastAltitude   Float?
  battery        Float?
  droneMode      String?
  
  // Relations
  areaId        String? @db.ObjectId
  area          Area?   @relation(fields: [areaId], references: [id], onDelete: SetNull)
  
  flightHistory DroneFlightHistory[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("drone_os_settings")
}

model Alarm {
  id       String   @id @default(auto()) @map("_id") @db.ObjectId
  alarmId  String   @unique // Unique Alarm ID
  name     String   // Alarm name
  status   String   @default("Active") // Active/Inactive
  
  // Relations
  areaId  String? @db.ObjectId
  area    Area?   @relation(fields: [areaId], references: [id], onDelete: Cascade)
  
  sensors Sensor[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("alarms")
}

model Alert {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId

  // Relation to Sensor (Mongo ObjectId)
  sensorDbId String     @db.ObjectId
  sensor     Sensor     @relation(fields: [sensorDbId], references: [id], onDelete: Cascade)

  // Business / logical sensor ID (e.g. "SENSOR-001")
  sensorId   String

  type      String      // e.g. "ObjectDetected"
  message   String      // e.g. "Object detected in front of Sensor-1"
  time     String    // Time of the alert
  timestamp DateTime    @default(now()) // When the alert was created in the system

  status    AlertStatus @default(ACTIVE)

  createdAt DateTime    @default(now())
  decidedAt DateTime?
  decision  String?     // "send drone:693964e5985c84e3051ffa97" | "neutralised"

  metadata  Json?

  // Relations

  @@map("alerts")
  @@index([status])
  @@index([sensorDbId])
}

model DroneFlightHistory {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Relations
  droneDbId       String   @db.ObjectId
  drone           DroneOS  @relation(fields: [droneDbId], references: [id], onDelete: Cascade)
  
  // Business IDs for easy reference
  // droneId         String   // e.g., "DRONE-001"
  sensorId        String?   // e.g., "SENSOR-001"
  alertId         String?   // The alert ID that triggered this flight
  
  // Flight details
  dispatchedAt    DateTime @default(now())
  // completedAt     DateTime?
  // status          String   // e.g., "Dispatched", "In Flight", "Completed", "Aborted"
  
  // Optional flight data
  // flightDuration  Int?     // Duration in seconds
  // batteryUsed     Float?   // Battery percentage used
  // maxAltitude     Float?   // Max altitude reached during flight
  // distanceCovered Float?   // Distance covered in meters
  
  // notes           String?  // Any additional notes or observations
  // metadata        Json?    // Any additional data you want to store
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("drone_flight_history")
  @@index([droneDbId])
  @@index([dispatchedAt])
}

model OfflineMap {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId

  name        String
  description String?

  // Root path where tiles will be served from backend
  // Example: "/maps/<mapId>"
  tileRoot    String

  minZoom     Int
  maxZoom     Int

  north       Float
  south       Float
  east        Float
  west        Float

  isActive    Boolean  @default(false)

  // ðŸ”½ DOWNLOAD STATE (NEW)
  downloadStatus   String  @default("PENDING") // PENDING | DOWNLOADING | READY | FAILED
  downloadProgress Int     @default(0)         // 0 - 100
  downloadError    String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("offline_maps")
  @@index([isActive])
}
